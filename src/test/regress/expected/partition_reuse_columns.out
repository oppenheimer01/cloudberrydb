create schema partition_reuse_columns;
set search_path to partition_reuse_columns;
create table t1(a int, b int) partition by range(a) ;
create table p1 partition of t1 for values from (1) to (5);
create table p2 partition of t1 for values from (5) to (10) partition by range(b);
create table p2_1 partition of p2 for values from (1) to (3);
create table p2_2 partition of p2 for values from (3) to (6);
select relname, relreuseattrs from pg_class where relnamespace = 'partition_reuse_columns'::regnamespace order by relname;
 relname | relreuseattrs 
---------+---------------
 p1      | t
 p2      | t
 p2_1    | t
 p2_2    | t
 t1      | f
(5 rows)

create table p3(a int, b int);
-- reuse columns
alter table t1 attach partition p3 for values from (10) to (15);
select relname, relreuseattrs from pg_class where oid = 'p3'::regclass::oid;
 relname | relreuseattrs 
---------+---------------
 p3      | t
(1 row)

create table p4(b int, a int, c int);
alter table p4 drop column c;
-- not reuse columns
alter table t1 attach partition p4 for values from (15) to (20);
select relname, relreuseattrs from pg_class where oid = 'p4'::regclass::oid;
 relname | relreuseattrs 
---------+---------------
 p4      | f
(1 row)

-- reuse columns, include the dropped column
create table p5(a int, b int, c int);
alter table p5 drop column c;
alter table t1 add column c int;
alter table t1 drop column c;
alter table t1 attach partition p5 for values from (20) to (25);
select relname, relreuseattrs from pg_class where oid = 'p5'::regclass::oid;
 relname | relreuseattrs 
---------+---------------
 p5      | t
(1 row)

-- check after detach
alter table t1 detach partition p1;
select relname, relreuseattrs from pg_class where oid = 'p1'::regclass::oid;
 relname | relreuseattrs 
---------+---------------
 p1      | f
(1 row)

-- check after re-attach
alter table t1 attach partition p1 for values from (1) to (5);
select relname, relreuseattrs from pg_class where oid = 'p1'::regclass::oid;
 relname | relreuseattrs 
---------+---------------
 p1      | t
(1 row)

-- check after detach and alter tables
alter table t1 detach partition p1;
alter table p1 add column d int;
alter table p1 drop column d;
alter table t1 attach partition p1 for values from (1) to (5);
-- not reuse columns
select relname, relreuseattrs from pg_class where oid = 'p1'::regclass::oid;
 relname | relreuseattrs 
---------+---------------
 p1      | f
(1 row)

-- check alter columns
create table t2(a int, b int) partition by range(a) ;
create table p6 (a int, b int);
alter table t2 attach partition p6 for values from (25) to (30);
--
-- test alter default
--
select relname, relreuseattrs from pg_class where oid = 'p6'::regclass::oid;
 relname | relreuseattrs 
---------+---------------
 p6      | t
(1 row)

alter table p6 alter column b set default 10;
-- should not reuse
select relname, relreuseattrs from pg_class where oid = 'p6'::regclass::oid;
 relname | relreuseattrs 
---------+---------------
 p6      | f
(1 row)

-- should reuse after parent alter column
alter table t2 alter column b set default 100;
select relname, relreuseattrs from pg_class where oid = 'p6'::regclass::oid;
 relname | relreuseattrs 
---------+---------------
 p6      | t
(1 row)

-- should not reuse again
alter table p6 alter column b set default 99;
select relname, relreuseattrs from pg_class where oid = 'p6'::regclass::oid;
 relname | relreuseattrs 
---------+---------------
 p6      | f
(1 row)

-- should reuse again
alter table p6 alter column b set default 100;
select relname, relreuseattrs from pg_class where oid = 'p6'::regclass::oid;
 relname | relreuseattrs 
---------+---------------
 p6      | t
(1 row)

--
-- test alter statistics 
--
-- should not reuse
alter table p6 alter column b set STATISTICS 99;
select relname, relreuseattrs from pg_class where oid = 'p6'::regclass::oid;
 relname | relreuseattrs 
---------+---------------
 p6      | f
(1 row)

-- should reuse again
alter table p6 alter column b set STATISTICS -1;
select relname, relreuseattrs from pg_class where oid = 'p6'::regclass::oid;
 relname | relreuseattrs 
---------+---------------
 p6      | t
(1 row)

--
-- test alter NULL/NOT NULL
--
-- should not reuse
alter table p6 alter column b set NOT NULL;
select relname, relreuseattrs from pg_class where oid = 'p6'::regclass::oid;
 relname | relreuseattrs 
---------+---------------
 p6      | f
(1 row)

-- should reuse again
alter table p6 alter column b drop NOT NULL;
select relname, relreuseattrs from pg_class where oid = 'p6'::regclass::oid;
 relname | relreuseattrs 
---------+---------------
 p6      | t
(1 row)

--
-- test alter storage
--
alter table t2 add column c text;
select attstorage from pg_attribute where attrelid = 't2'::regclass::oid and attname = 'c'; 
 attstorage 
------------
 x
(1 row)

select attstorage from pg_attribute where attrelid = 'p6'::regclass::oid and attname = 'c'; 
 attstorage 
------------
 x
(1 row)

alter table p6 alter column c set storage main;
select attstorage from pg_attribute where attrelid = 'p6'::regclass::oid and attname = 'c'; 
 attstorage 
------------
 m
(1 row)

-- should not reuse
select relname, relreuseattrs from pg_class where oid = 'p6'::regclass::oid;
 relname | relreuseattrs 
---------+---------------
 p6      | f
(1 row)

-- should reuse again
alter table p6 alter column c set storage extended;
select relname, relreuseattrs from pg_class where oid = 'p6'::regclass::oid;
 relname | relreuseattrs 
---------+---------------
 p6      | t
(1 row)

ALTER TABLE t2 add COLUMN d int;
ALTER TABLE t2 ALTER COLUMN d set NOT NULL;
select attname, attnotnull from pg_attribute where attrelid = 'p6'::regclass::oid and attnum > 0;
 attname | attnotnull 
---------+------------
 a       | f
 b       | f
 c       | f
 d       | t
(4 rows)

select attname, attnotnull from pg_attribute where attrelid = 't2'::regclass::oid and attnum >0;
 attname | attnotnull 
---------+------------
 a       | f
 b       | f
 c       | f
 d       | t
(4 rows)

select relname, relreuseattrs from pg_class where oid = 'p6'::regclass::oid;
 relname | relreuseattrs 
---------+---------------
 p6      | t
(1 row)

ALTER TABLE t2 ALTER COLUMN d drop NOT NULL;
select attname, attnotnull from pg_attribute where attrelid = 'p6'::regclass::oid and attnum > 0; 
 attname | attnotnull 
---------+------------
 a       | f
 b       | f
 c       | f
 d       | f
(4 rows)

select attname, attnotnull from pg_attribute where attrelid = 't2'::regclass::oid and attnum > 0;
 attname | attnotnull 
---------+------------
 a       | f
 b       | f
 c       | f
 d       | f
(4 rows)

select relname, relreuseattrs from pg_class where oid = 'p6'::regclass::oid;
 relname | relreuseattrs 
---------+---------------
 p6      | t
(1 row)

--
-- test IDENTITY
--
ALTER TABLE t2 ALTER COLUMN d set NOT NULL;
select attname, attidentity from pg_attribute where attrelid = 'p6'::regclass::oid and attnum > 0; 
 attname | attidentity 
---------+-------------
 a       | 
 b       | 
 c       | 
 d       | 
(4 rows)

select attname, attidentity from pg_attribute where attrelid = 't2'::regclass::oid and attnum > 0;
 attname | attidentity 
---------+-------------
 a       | 
 b       | 
 c       | 
 d       | 
(4 rows)

select relname, relreuseattrs from pg_class where oid = 'p6'::regclass::oid;
 relname | relreuseattrs 
---------+---------------
 p6      | t
(1 row)

ALTER TABLE p6 ALTER COLUMN d ADD GENERATED ALWAYS AS IDENTITY;
select attname, attidentity from pg_attribute where attrelid = 'p6'::regclass::oid and attnum > 0; 
 attname | attidentity 
---------+-------------
 a       | 
 b       | 
 c       | 
 d       | a
(4 rows)

select attname, attidentity from pg_attribute where attrelid = 't2'::regclass::oid and attnum > 0;
 attname | attidentity 
---------+-------------
 a       | 
 b       | 
 c       | 
 d       | 
(4 rows)

select relname, relreuseattrs from pg_class where oid = 'p6'::regclass::oid;
 relname | relreuseattrs 
---------+---------------
 p6      | f
(1 row)

ALTER TABLE p6 ALTER COLUMN d DROP IDENTITY;
select attname, attidentity from pg_attribute where attrelid = 'p6'::regclass::oid and attnum > 0; 
 attname | attidentity 
---------+-------------
 a       | 
 b       | 
 c       | 
 d       | 
(4 rows)

select attname, attidentity from pg_attribute where attrelid = 't2'::regclass::oid and attnum > 0;
 attname | attidentity 
---------+-------------
 a       | 
 b       | 
 c       | 
 d       | 
(4 rows)

select relname, relreuseattrs from pg_class where oid = 'p6'::regclass::oid;
 relname | relreuseattrs 
---------+---------------
 p6      | t
(1 row)

--
-- test COMPRESSION
--
select attname, attcompression from pg_attribute where attrelid = 'p6'::regclass::oid and attnum > 0; 
 attname | attcompression 
---------+----------------
 a       | 
 b       | 
 c       | 
 d       | 
(4 rows)

select attname, attcompression from pg_attribute where attrelid = 't2'::regclass::oid and attnum > 0;
 attname | attcompression 
---------+----------------
 a       | 
 b       | 
 c       | 
 d       | 
(4 rows)

ALTER TABLE p6 ALTER COLUMN c SET compression pglz;
select attname, attcompression from pg_attribute where attrelid = 'p6'::regclass::oid and attnum > 0; 
 attname | attcompression 
---------+----------------
 a       | 
 b       | 
 c       | p
 d       | 
(4 rows)

select attname, attcompression from pg_attribute where attrelid = 't2'::regclass::oid and attnum > 0;
 attname | attcompression 
---------+----------------
 a       | 
 b       | 
 c       | 
 d       | 
(4 rows)

select relname, relreuseattrs from pg_class where oid = 'p6'::regclass::oid;
 relname | relreuseattrs 
---------+---------------
 p6      | f
(1 row)

ALTER TABLE p6 ALTER COLUMN c SET compression default;
select attname, attcompression from pg_attribute where attrelid = 'p6'::regclass::oid and attnum > 0; 
 attname | attcompression 
---------+----------------
 a       | 
 b       | 
 c       | 
 d       | 
(4 rows)

select attname, attcompression from pg_attribute where attrelid = 't2'::regclass::oid and attnum > 0;
 attname | attcompression 
---------+----------------
 a       | 
 b       | 
 c       | 
 d       | 
(4 rows)

select relname, relreuseattrs from pg_class where oid = 'p6'::regclass::oid;
 relname | relreuseattrs 
---------+---------------
 p6      | t
(1 row)

-- GPDB partition grammar
create table region
(
	r_regionkey integer not null,
	r_name char(25),
	r_comment varchar(152)
)
partition by range (r_regionkey)
subpartition by list (r_name) subpartition template
(
	subpartition africa values ('AFRICA'),
	subpartition america values ('AMERICA'),
	subpartition asia values ('ASIA'),
	subpartition europe values ('EUROPE'),
	subpartition mideast values ('MIDDLE EAST'),
	subpartition australia values ('AUSTRALIA'),
	subpartition antarctica values ('ANTARCTICA')
)
(
	partition region1 start (0),
	partition region2 start (3),
	partition region3 start (5) end (8)
);
select relname, relreuseattrs from pg_class where relnamespace = 'partition_reuse_columns'::regnamespace and relname like 'region%';
                relname                | relreuseattrs 
---------------------------------------+---------------
 region                                | f
 region_1_prt_region1                  | t
 region_1_prt_region1_2_prt_africa     | t
 region_1_prt_region1_2_prt_america    | t
 region_1_prt_region1_2_prt_antarctica | t
 region_1_prt_region1_2_prt_asia       | t
 region_1_prt_region1_2_prt_australia  | t
 region_1_prt_region1_2_prt_europe     | t
 region_1_prt_region1_2_prt_mideast    | t
 region_1_prt_region2                  | t
 region_1_prt_region2_2_prt_africa     | t
 region_1_prt_region2_2_prt_america    | t
 region_1_prt_region2_2_prt_antarctica | t
 region_1_prt_region2_2_prt_asia       | t
 region_1_prt_region2_2_prt_australia  | t
 region_1_prt_region2_2_prt_europe     | t
 region_1_prt_region2_2_prt_mideast    | t
 region_1_prt_region3                  | t
 region_1_prt_region3_2_prt_africa     | t
 region_1_prt_region3_2_prt_america    | t
 region_1_prt_region3_2_prt_antarctica | t
 region_1_prt_region3_2_prt_asia       | t
 region_1_prt_region3_2_prt_australia  | t
 region_1_prt_region3_2_prt_europe     | t
 region_1_prt_region3_2_prt_mideast    | t
(25 rows)

create table foo_p (i int, j int)
partition by range(j)
(start(1) end(10) every(1));
select relname, relreuseattrs from pg_class where relnamespace = 'partition_reuse_columns'::regnamespace and relname like 'foo_p%';
    relname    | relreuseattrs 
---------------+---------------
 foo_p         | f
 foo_p_1_prt_1 | t
 foo_p_1_prt_2 | t
 foo_p_1_prt_3 | t
 foo_p_1_prt_4 | t
 foo_p_1_prt_5 | t
 foo_p_1_prt_6 | t
 foo_p_1_prt_7 | t
 foo_p_1_prt_8 | t
 foo_p_1_prt_9 | t
(10 rows)

--
-- test partition tables with children
--
create table p7 partition of t2 for values from (30) to (40) partition by range (a);
-- should not reuse as t2 has dropped columns
select relname, relreuseattrs from pg_class where oid in
 ('p7'::regclass::oid);
 relname | relreuseattrs 
---------+---------------
 p7      | f
(1 row)

drop table p7;
create table t3(a int, b int, c text) partition by range(a) ;
create table p7 partition of t3 for values from (1) to (40) partition by range (a);
create table p7_1 partition of p7 for values from (1) to (35);
create table p7_2 partition of p7 for values from (35) to (40);
select relname, relreuseattrs from pg_class where oid in
 ('p7'::regclass::oid, 
 'p7_1'::regclass::oid, 
 'p7_2'::regclass::oid);
 relname | relreuseattrs 
---------+---------------
 p7_1    | t
 p7      | t
 p7_2    | t
(3 rows)

-- test compression
select attrelid::regclass, attname, attcompression from pg_attribute where attrelid in
 ('t3'::regclass::oid, 
 'p7'::regclass::oid, 
 'p7_1'::regclass::oid, 
 'p7_2'::regclass::oid)
 and attnum > 0;
 attrelid | attname | attcompression 
----------+---------+----------------
 t3       | a       | 
 t3       | b       | 
 t3       | c       | 
 p7       | a       | 
 p7       | b       | 
 p7       | c       | 
 p7_1     | a       | 
 p7_1     | b       | 
 p7_1     | c       | 
 p7_2     | a       | 
 p7_2     | b       | 
 p7_2     | c       | 
(12 rows)

ALTER TABLE p7 ALTER COLUMN c SET compression pglz;
select attrelid::regclass, attname, attcompression from pg_attribute where attrelid in
 ('t3'::regclass::oid, 
 'p7'::regclass::oid, 
 'p7_1'::regclass::oid, 
 'p7_2'::regclass::oid)
 and attnum > 0;
 attrelid | attname | attcompression 
----------+---------+----------------
 t3       | a       | 
 t3       | b       | 
 t3       | c       | 
 p7       | a       | 
 p7       | b       | 
 p7       | c       | p
 p7_1     | a       | 
 p7_1     | b       | 
 p7_1     | c       | 
 p7_2     | a       | 
 p7_2     | b       | 
 p7_2     | c       | 
(12 rows)

-- shoud not reuse
select relname, relreuseattrs from pg_class where oid in
 ('p7'::regclass::oid, 
 'p7_1'::regclass::oid, 
 'p7_2'::regclass::oid);
 relname | relreuseattrs 
---------+---------------
 p7_1    | f
 p7_2    | f
 p7      | f
(3 rows)

-- p7_1 shoud reuse
ALTER TABLE p7_1 ALTER COLUMN c SET compression pglz;
select attrelid::regclass, attname, attcompression from pg_attribute where attrelid in
 ('t3'::regclass::oid, 
 'p7'::regclass::oid, 
 'p7_1'::regclass::oid, 
 'p7_2'::regclass::oid)
 and attnum > 0;
 attrelid | attname | attcompression 
----------+---------+----------------
 t3       | a       | 
 t3       | b       | 
 t3       | c       | 
 p7       | a       | 
 p7       | b       | 
 p7       | c       | p
 p7_1     | a       | 
 p7_1     | b       | 
 p7_1     | c       | p
 p7_2     | a       | 
 p7_2     | b       | 
 p7_2     | c       | 
(12 rows)

select relname, relreuseattrs from pg_class where oid in
 ('p7'::regclass::oid, 
 'p7_1'::regclass::oid, 
 'p7_2'::regclass::oid);
 relname | relreuseattrs 
---------+---------------
 p7_2    | f
 p7_1    | t
 p7      | f
(3 rows)

-- p7, p7_1 should reuse, but p7_2 not
ALTER TABLE t3 ALTER COLUMN c SET compression pglz;
select attrelid::regclass, attname, attcompression from pg_attribute where attrelid in
 ('t3'::regclass::oid, 
 'p7'::regclass::oid, 
 'p7_1'::regclass::oid, 
 'p7_2'::regclass::oid)
 and attnum > 0;
 attrelid | attname | attcompression 
----------+---------+----------------
 t3       | a       | 
 t3       | b       | 
 t3       | c       | p
 p7       | a       | 
 p7       | b       | 
 p7       | c       | p
 p7_1     | a       | 
 p7_1     | b       | 
 p7_1     | c       | p
 p7_2     | a       | 
 p7_2     | b       | 
 p7_2     | c       | 
(12 rows)

select relname, relreuseattrs from pg_class where oid in
 ('p7'::regclass::oid, 
 'p7_1'::regclass::oid, 
 'p7_2'::regclass::oid);
 relname | relreuseattrs 
---------+---------------
 p7_2    | f
 p7_1    | t
 p7      | t
(3 rows)

-- test not null
ALTER TABLE p7_2 ALTER COLUMN c SET compression pglz;
select relname, relreuseattrs from pg_class where oid in
 ('p7'::regclass::oid, 
 'p7_1'::regclass::oid, 
 'p7_2'::regclass::oid);
 relname | relreuseattrs 
---------+---------------
 p7_1    | t
 p7      | t
 p7_2    | t
(3 rows)

select attrelid::regclass, attname, attnotnull from pg_attribute where attrelid in
 ('t3'::regclass::oid, 
 'p7'::regclass::oid, 
 'p7_1'::regclass::oid, 
 'p7_2'::regclass::oid)
 and attnum = 3;
 attrelid | attname | attnotnull 
----------+---------+------------
 t3       | c       | f
 p7       | c       | f
 p7_1     | c       | f
 p7_2     | c       | f
(4 rows)

ALTER TABLE p7 ALTER COLUMN c SET not null;
select attrelid::regclass, attname, attnotnull from pg_attribute where attrelid in
 ('t3'::regclass::oid, 
 'p7'::regclass::oid, 
 'p7_1'::regclass::oid, 
 'p7_2'::regclass::oid)
 and attnum = 3;
 attrelid | attname | attnotnull 
----------+---------+------------
 t3       | c       | f
 p7       | c       | t
 p7_1     | c       | t
 p7_2     | c       | t
(4 rows)

select relname, relreuseattrs from pg_class where oid in
 ('p7'::regclass::oid, 
 'p7_1'::regclass::oid, 
 'p7_2'::regclass::oid);
 relname | relreuseattrs 
---------+---------------
 p7_1    | t
 p7_2    | t
 p7      | f
(3 rows)

-- drop not null on a leaf
ALTER TABLE p7 ALTER COLUMN c drop not null;
select attrelid::regclass, attname, attnotnull from pg_attribute where attrelid in
 ('t3'::regclass::oid, 
 'p7'::regclass::oid, 
 'p7_1'::regclass::oid, 
 'p7_2'::regclass::oid)
 and attnum = 3;
 attrelid | attname | attnotnull 
----------+---------+------------
 t3       | c       | f
 p7       | c       | f
 p7_1     | c       | f
 p7_2     | c       | f
(4 rows)

select relname, relreuseattrs from pg_class where oid in
 ('p7'::regclass::oid, 
 'p7_1'::regclass::oid, 
 'p7_2'::regclass::oid);
 relname | relreuseattrs 
---------+---------------
 p7_1    | t
 p7_2    | t
 p7      | t
(3 rows)

ALTER TABLE p7_2 ALTER COLUMN c set not null;
select attrelid::regclass, attname, attnotnull from pg_attribute where attrelid in
 ('t3'::regclass::oid, 
 'p7'::regclass::oid, 
 'p7_1'::regclass::oid, 
 'p7_2'::regclass::oid)
 and attnum = 3;
 attrelid | attname | attnotnull 
----------+---------+------------
 t3       | c       | f
 p7       | c       | f
 p7_1     | c       | f
 p7_2     | c       | t
(4 rows)

select relname, relreuseattrs from pg_class where oid in
 ('p7'::regclass::oid, 
 'p7_1'::regclass::oid, 
 'p7_2'::regclass::oid);
 relname | relreuseattrs 
---------+---------------
 p7_1    | t
 p7_2    | f
 p7      | t
(3 rows)

ALTER TABLE p7_2 ALTER COLUMN c drop not null;
select attrelid::regclass, attname, attnotnull from pg_attribute where attrelid in
 ('t3'::regclass::oid, 
 'p7'::regclass::oid, 
 'p7_1'::regclass::oid, 
 'p7_2'::regclass::oid)
 and attnum = 3;
 attrelid | attname | attnotnull 
----------+---------+------------
 t3       | c       | f
 p7       | c       | f
 p7_1     | c       | f
 p7_2     | c       | f
(4 rows)

select relname, relreuseattrs from pg_class where oid in
 ('p7'::regclass::oid, 
 'p7_1'::regclass::oid, 
 'p7_2'::regclass::oid);
 relname | relreuseattrs 
---------+---------------
 p7_1    | t
 p7_2    | t
 p7      | t
(3 rows)

-- test static
ALTER TABLE p7 ALTER COLUMN c set STATISTICS 11;
select attrelid::regclass, attname, attstattarget from pg_attribute where attrelid in
 ('t3'::regclass::oid, 
 'p7'::regclass::oid, 
 'p7_1'::regclass::oid, 
 'p7_2'::regclass::oid)
 and attnum = 3;
 attrelid | attname | attstattarget 
----------+---------+---------------
 t3       | c       |            -1
 p7       | c       |            11
 p7_1     | c       |            11
 p7_2     | c       |            11
(4 rows)

select relname, relreuseattrs from pg_class where oid in
 ('p7'::regclass::oid, 
 'p7_1'::regclass::oid, 
 'p7_2'::regclass::oid);
 relname | relreuseattrs 
---------+---------------
 p7_1    | t
 p7_2    | t
 p7      | f
(3 rows)

ALTER TABLE p7 ALTER COLUMN c set STATISTICS -1;
select attrelid::regclass, attname, attstattarget from pg_attribute where attrelid in
 ('t3'::regclass::oid, 
 'p7'::regclass::oid, 
 'p7_1'::regclass::oid, 
 'p7_2'::regclass::oid)
 and attnum = 3;
 attrelid | attname | attstattarget 
----------+---------+---------------
 t3       | c       |            -1
 p7       | c       |            -1
 p7_1     | c       |            -1
 p7_2     | c       |            -1
(4 rows)

select relname, relreuseattrs from pg_class where oid in
 ('p7'::regclass::oid, 
 'p7_1'::regclass::oid, 
 'p7_2'::regclass::oid);
 relname | relreuseattrs 
---------+---------------
 p7_1    | t
 p7_2    | t
 p7      | t
(3 rows)

-- test IDENTITY
ALTER TABLE t3 ALTER COLUMN b set NOT NULL;
select attrelid::regclass, attname, attidentity from pg_attribute where attrelid in
 ('t3'::regclass::oid, 
 'p7'::regclass::oid, 
 'p7_1'::regclass::oid, 
 'p7_2'::regclass::oid)
 and attnum = 2;
 attrelid | attname | attidentity 
----------+---------+-------------
 t3       | b       | 
 p7       | b       | 
 p7_1     | b       | 
 p7_2     | b       | 
(4 rows)

ALTER TABLE p7 ALTER COLUMN b ADD GENERATED ALWAYS AS IDENTITY;
select attrelid::regclass, attname, attidentity from pg_attribute where attrelid in
 ('t3'::regclass::oid, 
 'p7'::regclass::oid, 
 'p7_1'::regclass::oid, 
 'p7_2'::regclass::oid)
 and attnum = 2;
 attrelid | attname | attidentity 
----------+---------+-------------
 t3       | b       | 
 p7       | b       | a
 p7_1     | b       | 
 p7_2     | b       | 
(4 rows)

select relname, relreuseattrs from pg_class where oid in
 ('p7'::regclass::oid, 
 'p7_1'::regclass::oid, 
 'p7_2'::regclass::oid);
 relname | relreuseattrs 
---------+---------------
 p7_2    | f
 p7      | f
 p7_1    | f
(3 rows)

-- set IDENTITY
ALTER TABLE p7 ALTER COLUMN b SET GENERATED BY DEFAULT;
select attrelid::regclass, attname, attidentity from pg_attribute where attrelid in
 ('t3'::regclass::oid, 
 'p7'::regclass::oid, 
 'p7_1'::regclass::oid, 
 'p7_2'::regclass::oid)
 and attnum = 2;
 attrelid | attname | attidentity 
----------+---------+-------------
 t3       | b       | 
 p7       | b       | d
 p7_1     | b       | 
 p7_2     | b       | 
(4 rows)

select relname, relreuseattrs from pg_class where oid in
 ('p7'::regclass::oid, 
 'p7_1'::regclass::oid, 
 'p7_2'::regclass::oid);
 relname | relreuseattrs 
---------+---------------
 p7_2    | f
 p7      | f
 p7_1    | f
(3 rows)

 -- drop IDENTITY
ALTER TABLE p7 ALTER COLUMN b DROP IDENTITY;
select attrelid::regclass, attname, attidentity from pg_attribute where attrelid in
 ('t3'::regclass::oid, 
 'p7'::regclass::oid, 
 'p7_1'::regclass::oid, 
 'p7_2'::regclass::oid)
 and attnum = 2;
 attrelid | attname | attidentity 
----------+---------+-------------
 t3       | b       | 
 p7       | b       | 
 p7_1     | b       | 
 p7_2     | b       | 
(4 rows)

select relname, relreuseattrs from pg_class where oid in
 ('p7'::regclass::oid, 
 'p7_1'::regclass::oid, 
 'p7_2'::regclass::oid);
 relname | relreuseattrs 
---------+---------------
 p7      | t
 p7_1    | t
 p7_2    | t
(3 rows)

drop schema partition_reuse_columns cascade;
NOTICE:  drop cascades to 5 other objects
DETAIL:  drop cascades to table t1
drop cascades to table t2
drop cascades to table region
drop cascades to table foo_p
drop cascades to table t3
